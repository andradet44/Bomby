<!DOCTYPE html>

<html>
	<!-- En tête -->
	<head>
		<!-- Fichiers CSS -->
		<link rel='stylesheet' type='text/css' href='./css/web.css' media='screen' />

		<!-- Fichiers Javascripts -->
	<script type='text/javascript' src='./js/jquery-2.0.3.min.js'></script>

		<!-- Encodage UTF8 pour les accents -->
		<meta charset='UTF-8'>

		<!-- Icône de l'onglet -->
		<link rel='icon' type='image/png' href='./images/background_bomb.png' />

		<!-- Titre de l'onglet -->
		<title></title>
	</head>


	<!-- Corps du document -->
	<body>
<script>
$(document).ready(function(){
//Declarations
canvas = "", context = "", width = 0, height = 0, frames = 0, obstacle_list = [], players_list = [], floor_position = 0, actual_status = "play", character = "",
character_position = "", game_velocity = 6, jump_force = 20, actual_id = 0,
maxJump = 1, background = "", players = "";
actionLeft = actionRight = actionJump = action = actionHold = actionBomb = actionSelect = startAction = false;


//Class Obstacle
class Obstacle{
	constructor(id, position_floor, width_floor, height_floor){
		this.id = id;
		this.position = position_floor;
		this.height = height_floor;
		this.width = width_floor;
		this.color = "black";
	}

	//Drawing the floor
	draw_floor(){
		context.fillStyle = this.color;
		context.fillRect(this.position.x, this.position.y, this.width, this.height);
	}

}

//Class position
class Position{
	constructor(x_const, y_const){
		this.x = x_const;
		this.y = y_const;
	}

		right(){
			if(this.x < width-50 ){
				this.x += game_velocity;
			} else if (this.x >= width-50 ){
				this.x = width-50;
			}

		}

		left(){
			if(this.x > 0 ){
				this.x -= game_velocity;
			} else if (this.x <= 0 ){
				this.x = 0;
			}
		}

		jump(object){
			if(object.number_of_jump < maxJump){
				object.velocity = -jump_force;
			}
		}

	}

//Class Player
class Player{
	constructor(id, name, color){
		this.id = id;
		this.name = name;
		this.velocity = 0;
		this.width = 50;
		this.height = 50;
		this.gravity = 1;
		this.nb_alea = Math.floor(50 * Math.random());
		if(color == "default"){
			this.color = "#5858FA";
		}
		this.color = color;
		if(this.nb_alea <= 25){
			this.position = new Position(50, 0);
		} else if(this.nb_alea > 25){
			this.position = new Position(width - 100, 0);
		}
		this.number_of_jump = 0;
	}



	draw_player(){
		// var character_icon = new Image();
		// character_icon.src = "./images/character.png";
		// context.drawImage(character_icon, -this.width/2, -this.height/2);

		context.fillStyle = this.color;
		context.fillRect(this.position.x, this.position.y, this.width, this.height);
	};

	refresh_player(){
		this.velocity += this.gravity;
		this.position.y += this.velocity;


		if (this.position.y > (floor.position.y - this.height) && actual_status != "lost"){
			this.position.y = floor.position.y - this.height;
			this.velocity = 0;
			this.number_of_jump = 0;
		}

	};

}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////Starting the Script//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function main(){
	//Getting window information(height and width)
	height = window.innerHeight;
	width = window.innerWidth;

	//Creating the canvas
	canvas = document.createElement("canvas");
	canvas.height = height - 25;
	canvas.width = width - 20;

	canvas.style.border = "1px solid red";

	context = canvas.getContext("2d");

	//Adding canvas to html
	document.body.appendChild(canvas);

	//To avoid a flor to be confused with another one
	var last_position = 0;
	for (var id = 0; id < 10; id++){
		var condition = true;
		do{
			floor_position = new Position(Math.floor(width * Math.random()), Math.floor((height - 100) * Math.random()));

			if(last_position == 0){
				last_position = floor_position;
			}

			if(floor_position.y <  last_position.y + 60 || floor_position.y > last_position.y + 60){
				condition = false;
			}

		} while (condition);

		last_position = floor_position;

		floor = new Obstacle(id, floor_position, 200, 50);
		obstacle_list.push(floor);
	}
	menu();
}

function menu(){
		background = new Image();
		background.src = "./images/background.jpg";

		//When image loaded
		background.onload = function()
		{
			context.drawImage(background, 0, 0, width, height);
		}

		//drawSun();

		document.addEventListener("keydown", keyDown);
		document.addEventListener("keyup", keyUp);

		start();

}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////Let game playing////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Verify wich key was pressed and assing tru to tell that this key is being pressed
function keyDown(e){
	var right = 39, left = 37, space = 32, bomb = 68, coup = 81, hold = 90, select = 27;

	if (e.keyCode == right){
		actionRight = true;
	} else if(e.keyCode == left){
		actionLeft = true;
	} else if(e.keyCode == space){
		actionJump = true;
	} else if(e.keyCode == bomb){
		actionBomb = true;
	} else if(e.keyCode == coup){
		action = true;
	} else if(e.keyCode == hold){
		actionHold = true;
	} else if(e.keyCode == select){
		actionSelect = true;

		//Adding player before start game
		if(actionSelect && actual_status == "play"){
			var new_player = new Player(actual_id, "player"+actual_id, "default");
			players_list.push(new_player)
			actual_id += 1;

			var menu_modal = document.getElementById("menu");

			var player_name = document.createElement("h1");
			var newContent = document.createTextNode(new_player.name);
			player_name.appendChild(newContent);
			menu_modal.appendChild(player_name);
		}
	}
}

//Verify wich key was released and assing false to tell that this key stop being pressed
function keyUp(e){
	var right = 39, left = 37, space = 32, bomb = 68, coup = 81, hold = 90, select = 27;

	if (e.keyCode == right){
		actionRight = false;
	} else if(e.keyCode == left){
		actionLeft = false;
	} else if(e.keyCode == space){
		actionJump = false;
	} else if(e.keyCode == bomb){
		actionBomb = false;
	} else if(e.keyCode == coup){
		action = false;
	} else if(e.keyCode == hold){
		actionHold = false;
	} else if(e.keyCode == select){
		actionSelect = false;
	}
}

//Mouve the character
function mouve(){
	if (actionLeft){
		character.position.left();
	} else if(actionRight){
		character.position.right();
	} else if(actionJump){
		if(character.number_of_jump < maxJump){
			character.position.jump(character);
			character.number_of_jump++;
		}

	} else if(action){
		//character.bomb();
	} else if(actionHold){
		//character.coup();
	} else if(actionBomb){
		//character.hold();
	} else if(actionEsc){
	}
}

function refresh(){
	for (var id = 0; id < players_list.length; id++){
		players_list[id].refresh_player();
	}
}

//Function play is the function wich permit to the game to have an infinite loop
function start(){
	//Permit to request for commands
	sendAjax_commands();

	refresh();
	draw();

	window.requestAnimationFrame(start);
}

function draw(){

	if(actual_status == "playing"){
			jQuery("#menu").hide();

		for (var id = 0; id < obstacle_list.length; id++){
			obstacle_list[id].draw_floor();
		}
	}

	if(actual_status == "play"){
		jQuery("#menu").show();
	}

	for (var id = 0; id < players_list.length; id++){
		players_list[id].draw_player();
	}

}



//SENDING AJAX to request for commands
function sendAjax_commands(player_id = 1) {
	//tableau
	var jsonObject = {'player_id': player_id};

	// Serialise objet JSON
	var clientData = JSON.stringify(jsonObject);

	// Envoyer donnees JSON
	jQuery.ajax({type: "POST", url: "receiveAjax.php", dataType: "JSON", data: 'clientData=' + clientData,
		success: function(serverData) {
			// Traiter reponse serveur
			receiveAjax_commands(serverData);
		}
	});
}

//SENDING AJAX to request for players
function sendAjax_players() {
	// Remplissage objet JSON
	var player_id = 1;

	//tableau
	var jsonObject = {'player_id': player_id};

	// Serialise objet JSON
	var clientData = JSON.stringify(jsonObject);

	// Envoyer donnees JSON
	jQuery.ajax({type: "POST", url: "receiveAjax.php", dataType: "JSON", data: 'clientData=' + clientData,
	success: function(serverData) {
		// Traiter reponse serveur
		receiveAjax(serverData);
	}
});
}

//RECEIVING AJAX
function receiveAjax_commands(serverData) {
	// Tableau de données
	if (defined(serverData)) {
		for (val of serverData) {
			if(val.order.order == "right"){
				actionRight = true;
			} else if (val.order.order == "left"){
				actionLeft = true;
			}	else if(val.order.order == "jumps"){
				actionJump = true;
			} else if(val.order.order == "bomb"){
				actionBomb = true;
			} else if(val.order.order == "action"){
				action = true;
			} else if(val.order.order == "hold"){
				actionHold = true;
			} else if(val.order.order == "esc"){
				actionEsc = true;
			} else if(val.order.order == "start"){
				startAction = true;
				actual_status = "playing";
			}
		}
	}
}


//Draw a sun
function drawSun(){
	var rg = context.createRadialGradient(1100, 64, 48, 1100, 64, 64);
	//sun color
	rg.addColorStop(0, 'white');
	rg.addColorStop(1, 'rgba(255, 255, 0, 0)');
	context.fillStyle = rg;
	context.fillRect(1000, 0, 200, 200);
}


//test if a variable is defined
function defined(myVar) {
	if (typeof myVar != 'undefined') return true;
	return false;
}





main();

});
</script>
		<div class="modal">
				<table class="menu" id="menu">
						<td> Instructions : connect your phone to the console </td>
					</tr>
					<tr>
						<td> and press select to join the game ! </td>
					</tr>
					<tr>
						<td> Press Start to begin the game </td>
					</tr>
				</table>
				<!-- <img class='background_bomb' src='./images/background_bomb.png'> -->
			</div>

	</body>
</html>
