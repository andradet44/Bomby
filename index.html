
<!DOCTYPE html>

<html>
	<!-- En tête -->
	<head>
		<!-- Fichiers CSS -->
		<link rel='stylesheet' type='text/css' href='./css/web.css' media='screen' />

		<!-- Fichiers Javascripts -->
	<script type='text/javascript' src='./js/jquery-2.0.3.min.js'></script>

		<!-- Encodage UTF8 pour les accents -->
		<meta charset='UTF-8'>

		<!-- Icône de l'onglet -->
		<link rel='icon' type='image/png' href='./images/background_bomb.png' />

		<!-- Titre de l'onglet -->
		<title> Bomby </title>
	</head>


	<!-- Corps du document -->
	<body class="body">
		<audio  id="sound_hit" preload="auto">
			<source src="./sounds/hit.mp3">
		</audio>

		<audio  id="sound_explosion" preload="auto">
			<source src="./sounds/explosion.wav">
		</audio>

		<audio  id="sound_countdown" preload="auto">
			<source src="./sounds/countdown.wav">
		</audio>

		<audio  id="sound_back" preload="auto">
			<source src="./sounds/sound_back.mpeg">
		</audio>
<script>
$(document).ready(function(){
//Declarations
canvas = "", context = "", width = 0, height = 0, frames = 0, obstacle_list = [], commands_list = [], bombs_list = [], explosions_list = [], players_dead = 0, pause = false, canPause = true,
players_list = [], power_boxs_list = [] , floor_position = 0, actual_status = "play", game_end = 0, nb_obstacles = 15, level_start = 0, level_started = false;
game_velocity = 6, jump_force = 20, floor = "" , sprite_position = 0, winner_name = "anyone", winner_score = 0, actual_level = 0, gravity = 1, level_win = false, end_game_menu = false,
maxJump = 1, background = "";
actionSelect = startAction = false;


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////All class////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class Bomb{
	constructor(id, x, y){
		this.id = id;
		this.position = new Position(x, y);
		this.damage = 10;
		this.time_drawed = 0;
		this.drawed = false;
		this.width = 50;
		this.height = 50;
		this.velocity = 0;
		this.gravity = gravity;
		this.sound_countdown = document.getElementById('sound_countdown');
		this.sound_played = false;
	}

	draw_bomb(){
		var explosion = new Image();
		explosion.src = "./images/bomb.png";

		context.drawImage(explosion, this.position.x, this.position.y, this.width, this.height);
		if(this.sound_played == false){
			sound_countdown.play();
			this.sound_played = true;
		}
	}

	refresh_bomb(){
		//Applying gravity
		this.velocity += this.gravity;

		//Permit the power box to get on a platform
		for (var i = 0; i < obstacle_list.length; i++){
			var actual_obstacle = obstacle_list[i];
			if(this.position.x + 50 >= actual_obstacle.position.x && (this.position.x) <= (actual_obstacle.position.x + actual_obstacle.width)){
				if((this.position.y + 50) > actual_obstacle.position.y && (this.position.y + 50) < (actual_obstacle.position.y + actual_obstacle.height)){
					this.velocity = 0;
					this.position.y = actual_obstacle.position.y - 50;
				}
			}
		}

		//Avoid power bomb to past the floor
		if (this.position.y > (floor.position.y - 50)){
			this.position.y = floor.position.y - 50;
			this.velocity = 0;
		}

		this.position.y += this.velocity;
	}
}

//class Explosion
class Explosion{
	constructor(id, x, y, damage){
		this.id = id;
		this.position = new Position(x, y);
		this.drawed = false;
		this.time_drawed = 0;
		this.max_draw_time = 1;
		this.width = 200;
		this.height = 200;
		this.explosion_radius = 50;
		this.damage = damage;
		this.sound_explosion = document.getElementById('sound_explosion');
	}

	draw_explosion(){
		var explosion = new Image();
		explosion.src = "./images/explosion.png";

		context.drawImage(explosion, this.position.x, this.position.y, this.width, this.height);

		if(this.time_drawed >= this.max_draw_time){
			this.drawed = true;
		}
	}

	refresh_explosion(){
		for (var id = 0; id < players_list.length; id++){
			var actual_player = players_list[id];
			var x = actual_player.position.x;
			var y = actual_player.position.y;

			//Processing damage
			if((x + actual_player.width) >= (this.position.x - this.explosion_radius) && x <= (this.position.x + this.width + this.explosion_radius)){
				if((y + actual_player.height) >= (this.position.y - this.explosion_radius) && y <= (this.position.y + this.height + this.explosion_radius)){
					//If player have a shield it with protec him from the bomb but shield will break
					if(actual_player.power == 4 && actual_player.life >= 100){
						actual_player.life == 100;
					} else{
						actual_player.life -= this.damage;
						actual_player.position.y -= 20;
					}

					//Giving points to the player
					if(actual_player.life <= 0){
						for (var id1 = 0; id1 < players_list.length; id1++){
							var actual_player1 = players_list[id1];

							if(actual_player1.id == this.id && actual_player1.id != actual_player.id){
								actual_player1.score += 1;
							}
						}
					}
				}
			}
		}


	}
}

//Class Game_time
class Game_time{
	constructor(minute, second){
		this.second = second;
		this.minute = minute;
	}
}

//Class Power_Box
class Power_Box{
	constructor(){
		this.name = "";
		this.velocity = 0;
		this.gravity = 1;
		this.nb_alea = Math.floor(width * Math.random());

		this.color = "";
		//Random position
		this.position = new Position(this.nb_alea, 50);

		//Random power
		this.power = Math.floor(6 * Math.random());
		if(this.power == 0){
			this.power = 1;
		}

		//Power color
		if(this.power == 1){
			//Dead black
			this.color = "#000000";
		} else if(this.power == 2){
			//More damage orange
			this.color = "#FF8000";
		} else if(this.power == 3){
			//Life green
			this.color = "#40FF00";
		} else if(this.power == 4){
			//shield blue
			this.color = "#2EFEF7";
		} else if(this.power == 5){
			//Fly
			this.color = "#CC2EFA";
		} else if(this.power == 6){
			//triple bomb
			this.color = "#40FF00";
		}
	}

	//Drawing the power box
	draw_power_box(){
			if(this.power == 1){
				var death = new Image();
				death.src = "./images/death.png";

				context.drawImage(death,this.position.x, this.position.y, 50, 50);
			}

			if(this.power == 2){
				var glove_box = new Image();
				glove_box.src = "./images/glove_box.png";

				context.drawImage(glove_box,this.position.x, this.position.y, 50, 50);
			}

			if(this.power == 3){
				var health = new Image();
				health.src = "./images/health.png";

				context.drawImage(health,this.position.x, this.position.y, 50, 50);
			}

			if(this.power == 4){
				var shield = new Image();
				shield.src = "./images/shield.png";

				context.drawImage(shield,this.position.x, this.position.y, 50, 50);
			}

			if(this.power == 5){
				var fly = new Image();
				fly.src = "./images/bee.png";

				context.drawImage(fly,this.position.x, this.position.y, 50, 50);
			}

			if(this.power == 6){
				var triple_bomb = new Image();
				triple_bomb.src = "./images/triple_bomb.png";

				context.drawImage(triple_bomb,this.position.x, this.position.y, 50, 50);
			}

	}

	//Refreshing the power box
	refresh_power_box(){
		//Applying gravity
		this.velocity += this.gravity;

		//Permit the power box to get on a platform
		for (var id = 0; id < obstacle_list.length; id++){
			var actual_obstacle = obstacle_list[id];
			if(this.position.x + 50 >= actual_obstacle.position.x && (this.position.x) <= (actual_obstacle.position.x + actual_obstacle.width)){
				if((this.position.y + 50) > actual_obstacle.position.y && (this.position.y + 50) < (actual_obstacle.position.y + actual_obstacle.height)){
					this.velocity = 0;
					this.position.y = actual_obstacle.position.y - 50;
				}
			}
		}

		//Avoid power box to past the floor
		if (this.position.y > (floor.position.y - 50)){
			this.position.y = floor.position.y - 50;
			this.velocity = 0;
		}

		this.position.y += this.velocity;

	}
}

//Class Obstacle
class Obstacle{
	constructor(id, position_floor, width_floor, height_floor){
		this.id = id;
		this.position = position_floor;
		this.height = height_floor;
		this.width = width_floor;
		this.color = "#ffdf70";
	}

	//Drawing the Obstacle
	draw_obstacle(){
		var obstacle = new Image();
		obstacle.src = "./images/platform.png";

		context.drawImage(obstacle,this.position.x, this.position.y, this.width, this.height);
	}

}

//Class position
class Position{
	constructor(x_const, y_const){
		this.x = x_const;
		this.y = y_const;
	}

	right(){
		//Move right
		if(this.x < width-50 ){ //Avoid player to past the right side
			this.x += game_velocity;

			//Collisions by left
			for (var id = 0; id < obstacle_list.length; id++){
				var actual_obstacle = obstacle_list[id];
				if((this.x + 50) >= actual_obstacle.position.x && this.x + 25 <= actual_obstacle.position.x){
					if((this.y + 100 ) > actual_obstacle.position.y && this.y < (actual_obstacle.position.y + actual_obstacle.height)){
						this.x = actual_obstacle.position.x - 50;
					}
				}
			}

		} else if (this.x >= width-50 ){ //Avoid player to past the right side
			this.x = width-50;
		}

	}

	//Move left
	left(){
		if(this.x > 0 ){
			this.x -= game_velocity;

			//Collisions by right
			for (var id = 0; id < obstacle_list.length; id++){
				var actual_obstacle = obstacle_list[id];
				if(this.x <= (actual_obstacle.position.x + actual_obstacle.width) && this.x + 25 >= (actual_obstacle.position.x + actual_obstacle.width)){
					if((this.y + 100 ) >= actual_obstacle.position.y && this.y <= (actual_obstacle.position.y + actual_obstacle.height)){
						this.x = actual_obstacle.position.x + actual_obstacle.width;
					}
				}
			}

		} else if (this.x <= 0 ){
			this.x = 0;
		}
		}
	}

//Class Player
class Player{
	constructor(id, name, color){
		this.id = id;
		this.velocity = 0;
		this.width = 50;
		this.height = 100;
		this.gravity = 0;
		this.nb_alea = Math.floor(width * Math.random());
		if(color == "default"){
			this.color = "#FF0040";
			this.oldColor = "#FF0040";
		} else {
			this.color = color;
			this.oldColor = color;
		}

		this.position = new Position(this.nb_alea, 0);

		this.number_of_jumps = 0;
		this.power = 0;
		this.shield = 0;
		this.damage = 0.5;
		this.time_reappear = 5;
		this.time_power = 10;
		this.life = 100;
		this.score = 0;
		this.sound_hit = document.getElementById('sound_hit');
		this.sound_explosion = document.getElementById('sound_explosion');
		this.y_reappear = 50;
		this.death_position = 0;
		this.number_of_bombs = 0;
		this.max_bombs = 1;
		this.bomb_time = 5;
		this.maxJump = maxJump;


		//name
		this.name = name;
		this.name_position = new Position(0, 0);


		//Actions
		this.actionRight = false;
		this.stepRight = 1;
		this.actionLeft = false;
		this.stepLeft = -1;
		this.actionJump = false;
		this.actionBomb = false;
		this.ActionHit = false;
		this.actionHold = false;
		this.actionPause = false;
		this.time_pressed = 0;
		this.up = false;
		this.down = false;
		this.direction = "right";
		this.hitting = false;
	}

	draw_player(){
		if(this.direction == "right"){
			if(this.actionRight){
				this.stepRight += 0.2;
				this.actionRight = false;
			}
			if(this.stepRight >= 6){
				this.stepRight = 1;
			}

			if(this.hitting){
				var right = new Image();
				right.src = "./images/hitRight/hitRight.png";

				context.drawImage(right, this.position.x, this.position.y, 2 * this.width, this.height);
			} else{
				var right = new Image();
				right.src = "./images/right/" + Math.floor(this.stepRight) + ".png";

				context.drawImage(right, this.position.x, this.position.y, this.width, this.height);
			}
		}

		if(this.direction == "left"){
			if(this.actionLeft){
				this.stepLeft -= 0.2;
				this.actionLeft = false;
			}
			if(this.stepLeft <= -6){
				this.stepLeft = -1;
			}

			if(this.hitting){
				var left = new Image();
				left.src = "./images/hitLeft/hitLeft.png";

				context.drawImage(left, this.position.x - this.width, this.position.y, 2 * this.width, this.height);
			} else{
				var left = new Image();
				left.src = "./images/left/" + Math.floor(this.stepLeft) + ".png";

				context.drawImage(left, this.position.x, this.position.y, this.width, this.height);
			}
		}


		context.fillStyle = this.color;
		context.font = "20px Arial";

		if(this.life > 0){
			context.font = 20 + "px Arial";
			context.fillText(this.name, this.name_position.x, this.name_position.y);
			context.fillText(this.life, this.name_position.x, this.name_position.y + 20);

			var health = new Image();
			health.src = "./images/health.png";

			context.drawImage(health,this.name_position.x + 40, this.name_position.y, 20, 20);

		} else{
			context.fillText(this.name + " reappearing in : " + this.time_reappear + " sec", 50, this.y_reappear + this.death_position * 30);
		}

		this.hitting = false;
	}

	refresh_player(){
		if(level_started){
			this.gravity = gravity;
		}

		if(this.life > 0){
			//Refresh name position
			this.name_position.y = this.position.y - 25;
			this.name_position.x = this.position.x;


			//Make Player jump
			if(this.actionJump && this.number_of_jumps <= this.maxJump){
				this.velocity = -jump_force;
				this.number_of_jumps += 1;
				this.actionJump = false;

			} else {
				//Applying gravity
				this.velocity += this.gravity;
				this.actionJump = false;
			}

			//Getting a new power
			if(this.power != 1){ //because power 1 is death
				for(var i = 0; i < power_boxs_list.length; i++){
					var actual_power_box = 	power_boxs_list[i];

					if(this.position.x <= (actual_power_box.position.x + 50) && (this.position.x + 50) >= actual_power_box.position.x){
						if((this.position.y + this.height) > actual_power_box.position.y && this.position.y < (actual_power_box.position.y + 50)){
							if(actual_power_box.power != 3){
								this.color = actual_power_box.color;
							}
							this.power = actual_power_box.power;
							power_boxs_list.splice(i, i+1);
						}
					}

				}
			}

			//more damage power (2)
			if(this.power == 2){
				this.damage = 5;
			}

			//Heal player
			if(this.power == 3){
				this.life = 100;
			}

			//adding shield --> life + 50
			if(this.power == 4 && this.shield == 0){
				this.shield = 1;
				this.life += 50;
			}

			//make player fly
			if(this.power == 5){
				this.maxJump += 1;
			}

			if(this.power == 6){
				this.max_bombs = 3;
			}

			for (var id = 0; id < obstacle_list.length; id++){
				var actual_obstacle = obstacle_list[id];

				//Permit the Player to get on a platform (collision by top)
				if(this.position.x + this.width >= (actual_obstacle.position.x + 5) && (this.position.x) <= (actual_obstacle.position.x + actual_obstacle.width - 5)){
					if((this.position.y + this.height) > actual_obstacle.position.y && (this.position.y) < (actual_obstacle.position.y + 5)){
						this.velocity = 0;
						this.position.y = actual_obstacle.position.y - this.height;
						this.number_of_jumps = 0;
					}
				}

				//Collision by bottom
				if(this.position.x + 50 > (actual_obstacle.position.x + 5) && (this.position.x) <= (actual_obstacle.position.x + actual_obstacle.width - 5)){
					if((this.position.y) <= (actual_obstacle.position.y + actual_obstacle.height) && (this.position.y + this.height) > (actual_obstacle.position.y)){
						this.velocity += this.gravity;
						this.position.y = actual_obstacle.position.y + actual_obstacle.height;
					}
				}
		}

		} else {
			//Applying gravity
			this.velocity += this.gravity;
		}

		this.position.y += this.velocity;

			if(this.life > 0){
				//Avoid player to past the floor
				if (this.position.y > (floor.position.y - this.height)){
					this.position.y = floor.position.y - this.height;
					this.velocity = 0;
					this.number_of_jumps = 0;
				}
			}

			//Avoid player to past the top
			if (this.position.y <= 0){
				this.position.y = 1;
				this.velocity = 0;
			}

	}

	hit(){
		this.hitting = true;

		//Testing for all players
		for (var id = 0; id < players_list.length; id++){
			var actual_player = players_list[id];

			//Hitting by left
			if((this.position.x + this.width + 50) >= (actual_player.position.x) &&
			(this.position.x + this.width) <= (actual_player.position.x + actual_player.width) &&
			(this.position.y + 20) >= actual_player.position.y &&
			(this.position.y + 10) <= (actual_player.position.y + actual_player.height) &&
			actual_player.id != this.id &&
			this.direction == "right"){

				actual_player.life = actual_player.life - this.damage;
				if(actual_player.life <= 0 && actual_player.time_reappear == 5){
					this.score += 0.5;
				}
				actual_player.position.y = actual_player.position.y - 5;
				actual_player.position.right();
				actual_player.sound_hit.play();
			}

			//Hitting by right
			if((this.position.x - 50) <= (actual_player.position.x + actual_player.width) &&
			(this.position.x) >= (actual_player.position.x) &&
			(this.position.y + 20) >= actual_player.position.y &&
			(this.position.y + 10) <= (actual_player.position.y + actual_player.height) &&
			actual_player.id != this.id &&
			this.direction == "left"){

				actual_player.life = actual_player.life - this.damage;
				actual_player.position.y = actual_player.position.y - 5;
				actual_player.position.left();
				actual_player.sound_hit.play();
			}
		}
	}

	bomb(){
		if(this.number_of_bombs <= this.max_bombs - 1){
			var newBomb = new Bomb(this.id, this.position.x, this.position.y + this.height/2);

			bombs_list.push(newBomb);
			this.number_of_bombs += 1;
		}
	}

	reappear(){
		for (var id = 0; id < players_list.length; id++){
			var actual_player = players_list[id];
			if(actual_player.life <= 0 && actual_player.position.y > width && actual_player.time_reappear == 0){
				actual_player.velocity = actual_player.gravity;
				actual_player.life = 100;
				actual_player.position.y = 0;
				actual_player.position.x = width/2;
				actual_player.color = actual_player.oldColor;
				actual_player.power = 0;
				actual_player.time_reappear = 5;
				actual_player.death_position = 0;
				players_dead -= 1;
			}
		}
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////Starting the Script//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function main(){
	var sound_back = document.getElementById('sound_back');
	//Count time of game
	game_time = new Game_time(0, 0);
	game_end = new Game_time(3, 0);
	level_start = new Game_time(0, 1);

	//Time function
	setInterval(function () {
		if(pause == false){
			refresh_time();
		} else {
			//
		}
	}, 1000);

	//Getting window information(height and width)
	height = window.innerHeight - 25;
	width = window.innerWidth - 20;

	//Defining floor position
	floor_position = new Position(0, height - 100);
	floor = new Obstacle(99, floor_position, width, 100);

	game_velocity = width * 0.007;
	// jump_force = 0.025 * height;
	gravity = 0.07 * game_velocity;

	//adding 1 power box each 30 sec
	setInterval(function () {
		if(pause == false){
			addPowerBox();
		} else{
			//
		}
	}, 15000);

	//Creating the canvas
	canvas = document.createElement("canvas");
	canvas.height = height;
	canvas.width = width;


	canvas.style.border = "1px solid red";

	context = canvas.getContext("2d");

	//Adding canvas to html
	document.body.appendChild(canvas);


	//TODO: test
	var new_player = new Player(155, "player15", "#FF00FF");
	players_list.push(new_player);

	//TODO: test
	var newPowerBox = new Power_Box();
	newPowerBox.power = 6;
	newPowerBox.color = "#FFFFFF";
	power_boxs_list.push(newPowerBox);


	background = new Image();
	background.src = "./images/back.png";


	//When image loaded
	background.onload = function()
	{
		context.drawImage(background, 0, 0, width, height - 100);
	}

	//Drawing floor
	var floor_draw = new Image();
	floor_draw.src = "./images/platform.png";

	floor_draw.onload = function()
	{
		context.drawImage(floor_draw,0, height - 100, width, 100);
	}

	play();
	sound_back.play();

}


function level_one(){
	//To avoid a platform to be confused with another one
	var last_position = 0;
	for (var id = 0; id < nb_obstacles; id++){
		var condition = true;
		do{
			floor_position = new Position(Math.floor(width * Math.random()), Math.floor((height - 100) * Math.random()));

			if(last_position == 0){
				last_position = floor_position;
			}


			if(floor_position.y + 50 < last_position.y + 10 || floor_position.y > last_position.y + 60){
				condition = false;
			}

			if(floor_position.y > height - 100){
				condition = true;
			}

			if(floor_position.y < 150){
				condition = true;
			}




		} while (condition);


		last_position = floor_position;

		var width_alea =  Math.floor(200 * Math.random());
		if(width_alea < 50){
			width_alea += 50;
		}
		newFloor = new Obstacle(id, floor_position, width_alea, 50);
		obstacle_list.push(newFloor);

	}
}


// function level_two(){
// 	console.log("sdfmldkf");
// }

function refresh_time(){
	if(actual_status == "playing" && level_started){
		if(game_time.second < 60){
			game_time.second += 1;
		} else{
			game_time.second = 0;
			game_time.minute += 1;
		}

		//Refreshing game time
		if(game_end.minute != 0 || game_end.second != 0){
			if(game_end.second == 0){
				game_end.minute -= 1;
				game_end.second = 60;
			} else{
				game_end.second -= 1;
			}
		}

		//Refreshing time for all players (reappear, power and others)
		for (var id = 0; id < players_list.length; id++){
			var actual_player = players_list[id];

			//Bomb time
			if(actual_player.number_of_bombs >= actual_player.max_bombs && actual_player.bomb_time > 0){
				actual_player.bomb_time -= 1;
			} else{
				actual_player.number_of_bombs = 0;
				actual_player.bomb_time = 5;
			}

			//Counting time to aparition
			if(actual_player.life <= 0 && actual_player.time_reappear > 0){
				actual_player.time_reappear -= 1;
				actual_player.reappear();
			}

			if(actual_player.life > 0 && actual_player.power != 0){
				if(actual_player.time_power != 0){
					actual_player.time_power -= 1;
				} else{
					actual_player.time_power = 10;
					//Explosion when power = 1
					if(actual_player.time_power == 10 && actual_player.power == 1){
						actual_player.sound_explosion.play();
						var explosion = new Explosion(actual_player.id, actual_player.position.x - 100, actual_player.position.y, 25);
						explosions_list.push(explosion);

						if(actual_player.sound_explosion.currentTime == 0){
							actual_player.life = 0;
							players_dead += 1;
							actual_player.death_position = players_dead;
							actual_player.power = 0;
						}
					} else{
						actual_player.color = actual_player.oldColor;
						actual_player.maxJump = maxJump;
						actual_player.max_bombs = 1;

					}
						actual_player.power = 0;

					if(actual_player.power == 4){
						actual_player.shield = 0;
					}
				}
			}
		}

		//Refreshing explosion_time
		for (var i = 0; i < explosions_list.length; i++){
			var actual_explosion = explosions_list[i];

			if(actual_explosion.time_drawed < actual_explosion.max_draw_time){
				actual_explosion.time_drawed += 1;
			}
		}


		//Refreshing bomb time
		for (var i = 0; i < bombs_list.length; i++){
			var actual_bomb = bombs_list[i];

			if(actual_bomb.time_drawed < 4){
				actual_bomb.time_drawed += 1;
			} else{
				actual_bomb.drawed = true;
			}
		}


	}
		//refreshing game start time
		if(level_start.second >= 0){
			if(actual_status == "playing" && !level_started){
				level_start.second -= 1;
			}
		} else{
			level_start.second = 10;
			level_started = true;

			if(actual_level == 0){
				level_one();
			}
		}
}

function addPowerBox(){
	if(actual_status == "playing"){
		var newPowerBox = new Power_Box();
		power_boxs_list.push(newPowerBox);
	}
}

//Move the player
function move(){
	for (var id = 0; id < players_list.length; id++){
		var actual_player = players_list[id];

		if(actual_player.actionPause){
			console.log(actual_player.time_pressed);
			if(actual_player.time_pressed >= 2 && actual_player.time_pressed <= 50){
				actual_player.time_pressed += 1;
			} else{
				actual_player.time_pressed = 0;
			}

				if(level_started == true && (actual_player.time_pressed <= 1 || actual_player.time_pressed >= 50)){
					actual_player.time_pressed = 2;
					if(pause){
						pause = false;
					} else{
						pause = false;
					}
				} else {
					console.log("wait");
				}

			actual_player.actionPause = false;
		}




		if(actual_player.actionRight && pause == false){
			actual_player.position.right();
			actual_player.direction = "right";

		} else if (actual_player.actionLeft && pause == false){
				actual_player.position.left();
				actual_player.direction = "left";

		}	else if(actual_player.actionJump){
			//Action jump is not processed here

		} else if(actual_player.actionBomb && pause == false){
				actual_player.bomb();
				actual_player.actionBomb = false;

		} else if(actual_player.ActionHit && pause == false){
				actual_player.hit();
				actual_player.ActionHit = false;

		} else if(actual_player.actionHold){
				//TODO: hold
				actual_player.actionHold = false

		} else if(actual_player.up && pause == false){
				//TODO: find an action with up button
				actual_player.up = false;

		}	else if(actual_player.down && pause == false){
				//TODO: find an action with down button
				actual_player.down = false;

		}
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////Playing game///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function refresh(stop){

	if(game_end.minute == 0 && game_end.second == 0 || level_win){
		var modal_game_end = document.getElementById("game_end");


		if(modal_game_end.style.display != "block"){
			var winner_modal = document.getElementById("winner");

			var winner_info = document.createElement("td");
			var newContent = document.createTextNode("The winner is : " + winner_name + " with " + winner_score + " points.");
			winner_info.appendChild(newContent);
			winner_modal.appendChild(winner_info);
		}

		modal_game_end.style.display = "block";

		end_game_menu = true;
	} else{
			var modal_game_end = document.getElementById("game_end");

			modal_game_end.style.display = "none";
	}

	//Refresh all players
	for (var id = 0; id < players_list.length; id++){
		var actual_player = players_list[id];
		actual_player.refresh_player();

		if(actual_player.score > winner_score){
			winner_score = actual_player.score;
			winner_name = actual_player.name;
		}
	}

	//Refresh all power boxes
	for(var i = 0; i < power_boxs_list.length; i++){
		power_boxs_list[i].refresh_power_box();
	}

	//Refresh all explosions
	for(var i = 0; i < explosions_list.length; i++){
		var actual_explosion = explosions_list[i];

		if(actual_explosion.time_drawed < actual_explosion.max_draw_time){
			actual_explosion.refresh_explosion();
		}

		if(actual_explosion.drawed){
			actual_explosion.sound_explosion.play();
			explosions_list.splice(i, i+1);
		}
	}

	//Refresh all bombs
	for(var i = 0; i < bombs_list.length; i++){
		var actual_bomb = bombs_list[i];

		actual_bomb.refresh_bomb();


		if(actual_bomb.drawed){
			bombs_list.splice(i, i+1);

			var newExplosion = new Explosion(actual_bomb.id, actual_bomb.position.x - 100, actual_bomb.position.y - 100, actual_bomb.damage);

			explosions_list.push(newExplosion);
		}
	}
}

//Function play is the function wich permit to the game to have an infinite loop
function play(){

	//Displaye pause Menu
	if(pause){
		var modal_pause = document.getElementById('modal_pause');
		modal_pause.style.display = "block";
	} else{
		var modal_pause = document.getElementById('modal_pause');
		modal_pause.style.display = "none";
	}


	if(pause == false){
		refresh(stop);
	}
	if(game_end.minute == 0 && game_end.second > 0 || game_end.minute > 0){
		draw();
	}
	//Permit to request for commands
	sendAjax_commands();
	//Processing commands
	commands();
	//Move player
	move();

	var stop = window.requestAnimationFrame(play);
}

function draw(){

	if(actual_status == "playing"){
			jQuery("#menu").hide();

		//Drawing all obstacles
		for (var id = 0; id < obstacle_list.length; id++){
			obstacle_list[id].draw_obstacle();
		}

		//Drawing all power boxes
		for(var i = 0; i < power_boxs_list.length; i++){
			power_boxs_list[i].draw_power_box();
		}
	}

	if(actual_status == "play"){
		jQuery("#menu").show();
	}

	//Drawing all players
	for (var id = 0; id < players_list.length; id++){
		players_list[id].draw_player();
	}

	//Showing time to start level 1
	if(level_start.second > 0 && actual_status == "playing" && actual_level == 0 && level_started == false){

			var marge = width/15;
			var margeY = height/12;
			var largeurX = width - marge;
			var largeurY = height - marge;
			var initX = (width -largeurX)/2;
			var initY = (height -largeurY)/2;
			context.fillStyle = "#8A0886";
			context.fillRect(initX, initY, largeurX, largeurY);

			context.fillStyle = "#FFFFFF";
			context.font = 0.03 * width + "px Arial";
			context.textAlign = "center";
			context.fillText("Level 1 : Anyone is your friend now.", width/2, height/2 - 3*margeY);

			context.fillText("Game : death match.", width/2, height/2 - 2*margeY);

			context.fillText("Kill the most players to win the game", width/2, height/2 - 1*margeY);


			context.fillText("Starting game in " + level_start.second + " seconds ", width/2, height/2);

	}

	//Showing time to start level 2 //TODO
	if(level_start.second > 0 && actual_status == "playing" && actual_level == 1 && level_started == false){
		context.fillStyle = "#FFFFFF";
		context.font = "50px Arial";

		context.fillText("Level 2 : The flag .", width/2 - 300, 100);

		context.fillText("Keep close to the flag by 30 sec", width/2 - 300, 200);


		context.fillText("Starting game in " + level_start.second + " seconds ", width/2 - 300, height/2);
	}


	//Showing game time
	if(actual_status == "playing" && level_started){
		context.fillStyle = "#FFFFFF";
		context.font = "20px Arial";

		context.fillText("Game end " + game_end.minute + " : " + game_end.second, width/2 - 100, 20);
	}

	// context.fillStyle = "#FF0040";
	//
	// context.beginPath();
  // context.arc(50, 50, 50, 0, 2 * Math.PI);
	// context.fill();
 	// context.stroke();

	for(var i = 0; i < bombs_list.length; i++){
		var actual_bomb = bombs_list[i];

		actual_bomb.draw_bomb();
	}

	//Drawing all explosions
	for(var i = 0; i < explosions_list.length; i++){
		var actual_explosion = explosions_list[i];

		actual_explosion.draw_explosion();
	}

}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Controller Interaction/////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////
//SENDING AJAX to request for commands
function sendAjax_commands() {
		//tableau
		var jsonObject = {'none_value': ''};

		// Serialise objet JSON
		var clientData = JSON.stringify(jsonObject);

		// Envoyer donnees JSON
		jQuery.ajax({type: "POST", url: "receiveAjax.php", dataType: "JSON", data: 'clientData=' + clientData,
		success: function(serverData) {
			// Traiter reponse serveur
			receiveAjax_commands(serverData);
		}
	});
}

//RECEIVING AJAX
function receiveAjax_commands(serverData) {
	if (defined(serverData)) {
		for (val of serverData) {
			for(val2 of val.order){
				//Putting all commands in a list to process after
				if(defined(val2.player_id) && defined(val2.orders)){
					var value = val2.player_id + "," + val2.orders;

					commands_list.push(value);

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				//Actions before game start : "new player" and "start game"
				if(val2.orders && actual_status == "play"){
					actionSelect = true;
				}
				//TODO Change button start
				if(val2.orders == "down"){
					// startAction = true;
					actual_status = "playing";


					if(end_game_menu){
						window.location.reload();
					}

				}

				//Adding player before start game
				if(actionSelect && actual_status == "play"){
					var ifExist = false;
					//Permit to verify if a player is yet on the party, if not he is added to the party
					for (var id = 0; id < players_list.length; id++){
						if(val2.player_id == players_list[id].id){
							ifExist = true;
						}
					}

					if(!ifExist){
						var new_player = new Player(val2.player_id, val2.name, val2.color);
						players_list.push(new_player);

						var menu_modal = document.getElementById("menu");

						var player_name = document.createElement("h1");
						var newContent = document.createTextNode(new_player.name);
						player_name.appendChild(newContent);
						menu_modal.appendChild(player_name);
						}
					}
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				}
			}
		}
	}
}

//Processing commands
function commands(){
	for(var i = 0; i < commands_list.length; i++){
		var value = commands_list[i].split(',');
		var command = value[1];
		var player_id = value[0];


		if(command == "action_menu" && pause){
			window.location.replace("../menu/");
		} else if(command == "action_refresh" && pause){
			window.location.replace("./");
		}

		for (var id = 0; id < players_list.length; id++){
			if (player_id == players_list[id].id){
				if(command == "right" && level_started){
					players_list[id].actionRight = true;
				} else if (command == "left" && level_started){
					players_list[id].actionLeft = true;
				}	else if(command == "bouton_C" && level_started){
					players_list[id].actionJump = true;
				} else if(command == "bouton_B" && level_started){
					players_list[id].actionBomb = true;
				} else if(command == "bouton_D" && level_started){
					players_list[id].ActionHit = true;
				} else if(command == "bouton_A" && level_started){
					players_list[id].actionHold = true;
				} else if(command == "up"){
					players_list[id].up = true;
				}	else if(command == "down"){
					players_list[id].down = false;
				} else if(command == "action_leave" && pause){
					var test = players_list.splice(id,id+1);
				}
			}
		}

		if(command == "action_pause" && canPause && level_started){
			canPause = false;
			pause = !pause;
			setTimeout(function () {ResetPause();}, 500);
		}
	}
	commands_list = [];
}
function  ResetPause ()
{
	canPause = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//test if a variable is defined
function defined(myVar) {
	if (typeof myVar != 'undefined') return true;
	return false;
}

main();

});
</script>
		<div class="modal"  id="menu">
				<table class="menu" id="menu">
					<tr>
						<td> Instructions : connect your phone to the console </td>
					</tr>
					<tr>
						<td> and press any key to join the game ! </td>
					</tr>
					<tr>
						<td> Press Start to begin the game </td>
					</tr>
				</table>
		</div>

		<div class="modal_game_end"  id="game_end">
				<table class="menu" id="game_end">
					<tr id="winner">

					</tr>
					<tr id="points">
					</tr>
					<tr>
						<td> Press Start to restart the game </td>
					</tr>
				</table>
		</div>

		<div class="modal"  id="modal_pause">
			<table class="menu">

				<tr>
					<td> Game Paused </td>
				</tr>

				<tr>
					<td> Press Start to restart the game </td>
				</tr>

				<tr>
					<td> Press Main menu to quit game </td>
				</tr>
			</table>
		</div>

	</body>
</html>
